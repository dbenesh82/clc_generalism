---
title: "Cross-stage tradeoffs"
author: "Dan Benesh"
date: "21/01/2020"
output: github_document
---

This notebook tests the idea that there is an organism-level constraint on generality. If there is a 'ceiling' on the total number of hosts a parasite can infect, i.e. there are tradeoffs within a life cycle, then the average number of hosts per stage should decrease with life cycle length. If the relationship is constant or positive, then the species-level generality will increase with life cycle complexity.

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

```{r}
hosts_per_stage <- read.csv(file = "../../data/stage_level_combined.csv", header = TRUE)
```
```{r}
tax.ranks <- c('genus', 'family', 'order', 'class', 'phylum') # for axis label
```
```{r}
hosts_per_stage <- mutate(hosts_per_stage, Host_no_fac = if_else(Host.no > 4, as.integer(4), Host.no))%>%
  mutate(Host_no_fac = factor(Host_no_fac))
```
```{r}
# center log-transformed study effort
hosts_per_stage <- mutate(hosts_per_stage, zstudy_effort = 
                log10(study_effort+1) - mean( log10(study_effort+1), na.rm=T))
# hosts_per_stage <- mutate(hosts_per_stage, zstudy_effort =
#                 log10(study_effort+1) - quantile(log10(study_effort+1), probs = 0.75) )

hosts_per_stage$obs <- factor(1:length(hosts_per_stage$Parasite.species)) # observation level effect for quantifying overdispersion
```

From the stage-level data table, the average generality per stage was calculated for each species. The stage-level data were produced from just the life cycle database, so it does not include the additional host records from the NHM database. We excluded species that did not have full life cycle data.

```{r}
stage_avg <- hosts_per_stage%>%
  group_by(Parasite.species)%>%
  summarize(tot_hr = sum(num_hosts_suspicious_removed, na.rm = T), hr = mean(num_hosts_suspicious_removed, na.rm=T), 
            hsi = mean(hsi_lcdb_suspcious_rem, na.rm=T),
            var_hr = var(num_hosts_suspicious_removed, na.rm = T), var_hsi = var(hsi_lcdb_suspcious_rem, na.rm = T))
```
```{r}
stage_avg <- left_join(stage_avg, 
                       select(hosts_per_stage, Parasite.species, 
                              parasite_genus, parasite_family, parasite_order, parasite_class, parasite_phylum,
                              partial_cycle, lcl_max, lcl_min, lcl_max_fac, study_effort, zstudy_effort)%>%distinct())
```
```{r}
stage_avg <- filter(stage_avg, partial_cycle != 'partial') # just complete life cycles
```
```{r}
stage_avg$obs <- 1:length(stage_avg$Parasite.species)
```

Number of species:

```{r}
n_distinct(stage_avg$Parasite.species)
```

Number of host records:

```{r}
sum(stage_avg$tot_hr)
```

Here is the plot of the average number of hosts per stage as a function of life cycle length.

```{r}
ggplot(stage_avg, aes(y = hr, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.2, position = position_jitter(width = 0.25, height = 0), 
             aes(size = study_effort)) +
  scale_y_log10() +
  labs(x = "Life cycle length (max)", y = "Average number of hosts per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(a)", x = 0.55, y = max(stage_avg$hr))
```

Here is the same plot but for taxonomic dissimilarity.

```{r}
ggplot(stage_avg, aes(y = hsi, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.2, position = position_jitter(width = 0.25, height = 0), 
             aes(size = study_effort)) +
  scale_y_continuous(limits = c(1,5), breaks = c(1:6), labels = c("species", tax.ranks)) +
  labs(x = "Life cycle length (max)", y = "Average taxonomic dissimilarity per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(legend.position = c(0.98, 0.02),
        legend.justification = c(1,0),
        legend.background = element_rect(color = 'black'),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(b)", x = 0.55, y = max(stage_avg$hsi))
```

Both plots are inconsistent with a 'ceiling' on generalism. Instead average generalism per stage increases with longer life cycles, because these cycles include low-growth, high-generalism stages.

Now, we'll make the same statistical models that we did for tests of [species-level generalism](sp_level_analysis_host_range_freq.md), except we are modeling average generalism per stage instead of total generalism. We follow the same model-building sequence. We add parasite taxonomy, then study effort, and finally life cycle length as either a continuous or categorical variable.

```{r}
library(lme4)
```

# Host range

Our first generalism metric, number of hosts, is a count, which is why we analyzed it with a generalized linear mixed model with Poisson errors. However, when averaged across stages it is no longer an integer. We'll therefore analyze this generalism metric first as a continuous variable (linear mixed model with Gaussian errors) and then as a count (rounded to be an integer and then tested with a GLMM, Poisson errors).

Likelihood ratio tests indicate that study effort and life cycle length improve the model, but the categorical life cycle length does not. This suggests the positive relationship between average generality and life cycle length is linear.

```{r}
reg1f <- lmer(log(hr) ~ 1 + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
              data = stage_avg) # add taxonomy
reg2f <- update(reg1f, . ~ . + zstudy_effort) # add study effort
reg3f <- update(reg2f, . ~ . + lcl_max) # add max life cycle length as covariate
reg3.1f <- update(reg2f, . ~ . + lcl_max_fac) # add max life cycle length as covariate
reg4f <- update(reg3.1f, . ~ . + lcl_min) # distinguish fac life cycles
anova(reg1f, reg2f, reg3f, reg3.1f, reg4f)
```

```{r}
# summary(reg3f)
```

```{r}
lcl_effect <- fixef(reg3f)['lcl_max']
# exp(lcl_effect) - 1
```

The estimated slope for life cycle length was `r round(lcl_effect,3)`, which corresponds to a percent change of `r round((exp(lcl_effect)-1) * 100, 2)`% hosts per stage with each additional step in the life cycle.

The residual plot (not shown) does not look terrible, but let's make sure the results are robust to the model structure. We'll now fit the same series of models, but as generalized linear mixed models, in which the response (average generalism) is rounded to the nearest integer. Here is the table of likelihood ratio tests. Essentially, the results are the same.

```{r}
reg0p <- glmer(round(hr, 0) ~ 1 + (1|obs),
            data = stage_avg,
            REML=T,
            family = 'poisson'
            )
reg1p <- update(reg0p, . ~ . + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum)) # add taxonomy
reg2p <- update(reg1p, . ~ . + zstudy_effort) # add study effort
reg3p <- update(reg2p, . ~ . + lcl_max) # add max life cycle length as covariate
reg3.1p <- update(reg2p, . ~ . + lcl_max_fac) # add max life cycle length as covariate
reg4p <- update(reg3.1p, . ~ . + lcl_min) # distinguish fac life cycles
anova(reg1p, reg2p, reg3p, reg3.1p, reg4p)
```

Therefore, we'll take the results from the LMM that do not involve rounding. Let's creat the R^2^ table for average generalism.

```{r}
r2_lmm_tax <- function(model) {
  # marginal r2 is just fixed effects
  # condition r2 is fixed and rand effects combined
  
  # model call
  call <- as.character(model@call)[2]

  # parameter estimates and df
  fixed_param <- fixef(model)
  df <- length(fixed_param) - 1

  # variance due to fixed effects
  pred <- as.vector(model.matrix(model) %*% fixed_param) # predicteds on basis of just fixed effects
  varF <- var(pred)

  # variance due to rand effects
  vc <- as.data.frame(VarCorr(model))
  varE <- filter(vc, grp == "Residual")$vcov # residual var
  vc <- filter(vc, grp != "Residual")
  varR <- sum(vc$vcov) # random effect var

  # marginal r2
  mr2 <- varF/(varF + varR + varE)

  # conditional r2
  cr2 <- (varF + varR)/(varF + varR + varE)

  # output
  out_frame <- data_frame(call = call, df = df, marg_r2 = round(mr2, 3), cond_r2 = round(cr2,3))
  return(out_frame)
}
```
```{r}
mod_list <- list(reg1f, reg2f, reg3f, reg3.1f, reg4f)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}

r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", 
                   "life cycle length", "life cycle length, factor", "facultative life cycle")
r2_table <- dplyr::select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

# Taxonomic dissimilarity

What about the second generalism metric, taxonomic dissimilarity? We fit the same series of models (linear mixed models, Gaussian errors). Like for host range, average taxonomic dissimilarity is affected by study effort and life cycle length. The relationship with life cycle length appears linear, as treating lcl as a categorical variable was not an improvement.

```{r}
reg1f <- lmer(hsi ~ 1 + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
              data = stage_avg) # add taxonomy
reg2f <- update(reg1f, . ~ . + zstudy_effort) # add study effort
reg3f <- update(reg2f, . ~ . + lcl_max) # add max life cycle length as covariate
reg3.1f <- update(reg2f, . ~ . + lcl_max_fac) # add max life cycle length as covariate
reg4f <- update(reg3.1f, . ~ . + lcl_min) # distinguish fac life cycles
anova(reg1f, reg2f, reg3f, reg3.1f, reg4f)
```

These results do not support the hypothesis that there is an organism-level constraint on generalism. Instead of decreasing with more stages, average generalism per stage increased. Here's the R^2^ table for average tax dissimilarity per stage.

```{r}
mod_list <- list(reg1f, reg2f, reg3f, reg3.1f, reg4f)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}

r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", 
                   "life cycle length", "life cycle length, factor", "facultative life cycle")
r2_table <- dplyr::select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

# Add in the NHM data for host range

The analyses above were based only on the life cycle database. However, the main species-level analyses were based on combined host records from the life cycle database and the NHM database. Are the results similar with this expanded dataset? We can only check for one metric, the number of hosts. Here, we can simply divide the number of hosts by the number of stages to get an average generality per stage. For the other metric, taxonomic dissimilarity, we cannot divide the total dissimilarity by the number of stages, because dissimilarity is not a cumulative variable (e.g. genus + genus does not equal family).

```{r}
dat <- read.csv(file = "../../data/spp_level_combined.csv", header = TRUE)
```
```{r}
dat <- filter(dat, Parasite.species %in% stage_avg$Parasite.species)%>%
  mutate(hr = num_hosts_lcdb_nhm/lcl_max)
dat <- left_join(dat, select(stage_avg, Parasite.species, parasite_genus, parasite_family, parasite_order, parasite_class, parasite_phylum,
                             zstudy_effort, lcl_max_fac))
```

The average generality per stage is notably higher for one-host parasites, partly because they are better studied.

```{r}
ggplot(dat, aes(y = hr, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.2, position = position_jitter(width = 0.25, height = 0), 
             aes(size = pubs_pubmed_spname_group)) +
  scale_y_log10() +
  labs(x = "Life cycle length (max)", y = "Average number of hosts per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(a)", x = 0.55, y = max(dat$hr))
```

When we re-run the model series with these combined host records, we now find that adding life cycle length as a category improves the model, though the non-linear effect is weaker than the linear one.

```{r}
reg1f <- lmer(log(hr) ~ 1 + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
              data = dat) # add taxonomy
reg2f <- update(reg1f, . ~ . + zstudy_effort) # add study effort
reg3f <- update(reg2f, . ~ . + lcl_max) # add max life cycle length as covariate
reg3.1f <- update(reg2f, . ~ . + lcl_max_fac) # add max life cycle length as covariate
reg4f <- update(reg3.1f, . ~ . + lcl_min) # distinguish fac life cycles
anova(reg1f, reg2f, reg3f, reg3.1f, reg4f)
```

A look at the parameters suggests that one- and two-host life cycles have similar average generalism levels per stage, while three- and four-host cycles have higher averages per stage. This makes sense, since these cycles include the conspicuous high-generalism, low-growth stages.

```{r}
summary(reg3.1f)
```

Even though these results differ somewhat from those based only on the life cycle database, they still do not suggest an organism-level constraint on generalism. Average generalism per stage does not decline with longer life cycles.

