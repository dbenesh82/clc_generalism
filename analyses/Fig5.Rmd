---
title: "Fig6"
output: html_document
---
This notebook tests the idea that there is an organism-level constraint on generality. If there is a 'ceiling' on the total number of hosts a parasite can infect, i.e. there are tradeoffs within a life cycle, then the average number of hosts per stage should decrease with life cycle length. If the relationship is constant or positive, then the species-level generality will increase with life cycle complexity.

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

```{r}
hosts_per_stage <- read.csv(file = "../data/stage_level_combined.csv", header = TRUE)
```
```{r}
tax.ranks <- c('genus', 'family', 'order', 'class', 'phylum') # for axis label
```
```{r}
hosts_per_stage <- mutate(hosts_per_stage, Host_no_fac = if_else(Host.no > 4, as.integer(4), Host.no))%>%
  mutate(Host_no_fac = factor(Host_no_fac))
```
```{r}
# center log-transformed study effort
hosts_per_stage <- mutate(hosts_per_stage, zstudy_effort = 
                log10(study_effort+1) - mean( log10(study_effort+1), na.rm=T))
# hosts_per_stage <- mutate(hosts_per_stage, zstudy_effort =
#                 log10(study_effort+1) - quantile(log10(study_effort+1), probs = 0.75) )

hosts_per_stage$obs <- factor(1:length(hosts_per_stage$Parasite.species)) # observation level effect for quantifying overdispersion
```

From the stage-level data table, the average generality per stage was calculated for each species. The stage-level data were produced from just the life cycle database, so it does not include the additional host records from the NHM database. We excluded species that did not have full life cycle data.

```{r}
stage_avg <- hosts_per_stage%>%
  group_by(Parasite.species)%>%
  summarize(tot_hr = sum(num_hosts_suspicious_removed, na.rm = T), hr = mean(num_hosts_suspicious_removed, na.rm=T), 
            hsi = mean(hsi_lcdb_suspcious_rem, na.rm=T),
            var_hr = var(num_hosts_suspicious_removed, na.rm = T), var_hsi = var(hsi_lcdb_suspcious_rem, na.rm = T))
```
```{r}
stage_avg <- left_join(stage_avg, 
                       select(hosts_per_stage, Parasite.species, 
                              parasite_genus, parasite_family, parasite_order, parasite_class, parasite_phylum,
                              partial_cycle, lcl_max, lcl_max_fac, study_effort, zstudy_effort)%>%distinct())
```
```{r}
stage_avg <- filter(stage_avg, partial_cycle != 'partial') # just complete life cycles
```
```{r}
stage_avg$obs <- 1:length(stage_avg$Parasite.species)
```

Number of species

```{r}
n_distinct(stage_avg$Parasite.species)
```

Number of host records

```{r}
sum(stage_avg$tot_hr)
```

Here is the plot of the average number of hosts per stage as a function of life cycle length.

```{r}
ggplot(stage_avg, aes(y = hr, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.2, position = position_jitter(width = 0.25, height = 0), 
             aes(size = study_effort)) +
  scale_y_log10() +
  labs(x = "Life cycle length (max)", y = "Average number of hosts per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(a)", x = 0.55, y = max(stage_avg$hr))
```

Here is the same plot but for taxonomic dissimilarity.

```{r}
ggplot(stage_avg, aes(y = hsi, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.2, position = position_jitter(width = 0.25, height = 0), 
             aes(size = study_effort)) +
  scale_y_continuous(limits = c(1,5), breaks = c(1:6), labels = c("species", tax.ranks)) +
  labs(x = "Life cycle length (max)", y = "Average taxonomic dissimilarity per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(legend.position = c(0.98, 0.02),
        legend.justification = c(1,0),
        legend.background = element_rect(color = 'black'),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(b)", x = 0.55, y = max(stage_avg$hsi))
```

Both plots are inconsistent with a 'ceiling' on generalism. Instead average generalism per stage increases with longer life cycles, because these cycles include low-growth, high-generalism stages.

Now, we'll make the same statistical models that we did for tests of [species-level generalism](sp_level_analysis_host_range_freq.md), except we are modeling average generalism per stage instead of total generalism. Then we'll add the estimated means to the plots.

```{r}
library(lme4)
```

Our first generalism metric is number of hosts.

```{r}
reg1f <- lmer(log(hr) ~ zstudy_effort + lcl_max_fac + (1|parasite_genus) + (1|parasite_family) + 
                (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
              data = stage_avg)
```

```{r}
nd <- select(stage_avg, lcl_max_fac)%>%arrange(lcl_max_fac)%>%distinct()
nd$zstudy_effort <- 0
nd$hr <- 0
nd$lcl <- 1:4
pd <- model.matrix(terms(reg1f), nd)

nd$preds <- exp(predict(reg1f, newdata = nd, re.form = NA))

# bootstrap model
mySumm <- function(.) {
    c(beta=fixef(.))
}
bo <- bootMer(reg1f, mySumm, nsim = 500) # bootstrap the model
bx <- as.data.frame(bo)
bx <- select(bx, starts_with('beta'))
bx <- as.matrix(bx)

boots <- bx %*% t(pd) # predicted values for every observation for every bootstrap
boots <- as.data.frame(t(boots))
names(boots) <- as.character(c(1:500))
boots <- bind_cols(nd, boots)
boots <- pivot_longer(boots, `1`:`500`)

# first get predicted size at each stage for every bootstrap
boot_means <- boots%>%
  group_by(lcl_max_fac)%>%
  summarise(med_rg = exp(mean(value)), # mean and CI of the bootstraps
            high_rg = exp(quantile(value, probs = 0.975)),
            low_rg = exp(quantile(value, probs = 0.025)))
nd <- left_join(nd, boot_means)
```
```{r}
f1a2 <- ggplot(stage_avg, aes(y = hr, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.15, position = position_jitter(width = 0.3, height = 0),
             aes(size = study_effort)) +
  scale_y_log10(breaks = c(1, 5, 10, 25)) +
  scale_x_discrete(labels = c("1", "2", "3", "4 or 5")) +
  labs(x = "Life cycle length (max)", y = "Average number of hosts per stage", size = "Pubmed hits") +
  guides(size = F) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(a)", x = 0.55, y = max(stage_avg$hr)) +
  geom_line(data = nd, aes(x = lcl, y = preds), 
            alpha = 1, size = 1.5, color = 'black', linetype = 'dashed') +
  geom_linerange(data = nd, 
                  aes(x = lcl, y = preds,
                      ymin = low_rg, ymax = high_rg), 
                  size = 1.5, shape = 23, color = 'black', fill = 'black') +
  geom_point(data = nd,
             aes(x = lcl, y = preds),
             size = 4,
             shape = 23, color = 'black', fill = 'black')
# 
#   geom_line(data = nd, aes(x = lcl, y = preds), 
#             alpha = 1, size = 1.5, color = 'black', linetype = 'dashed') +
#   geom_point(data = nd, aes(x = lcl, y = preds), 
#             size = 5, shape = 23, color = 'black', fill = 'black')
f1a2
```

What about the second generalism metric, taxonomic dissimilarity? We fit the same series of models (linear mixed models, Gaussian errors). Like for host range, average taxonomic dissimilarity is affected by study effort and life cycle length. The relationship with life cycle length appears linear, as treating lcl as a categorical variable was not an improvement.

```{r}
reg1fx <- lmer(hsi ~ zstudy_effort + lcl_max_fac + (1|parasite_genus) + (1|parasite_family) + 
                (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
              data = stage_avg) # add taxonomy
```
```{r}
nd <- select(stage_avg, lcl_max_fac)%>%arrange(lcl_max_fac)%>%distinct()
nd$zstudy_effort <- 0
nd$hsi <- 0
nd$lcl <- 1:4
pd <- model.matrix(terms(reg1fx), nd)

nd$preds <- (predict(reg1fx, newdata = nd, re.form = NA))

# bootstrap model
mySumm <- function(.) {
    c(beta=fixef(.))
}
bo <- bootMer(reg1fx, mySumm, nsim = 500) # bootstrap the model
bx <- as.data.frame(bo)
bx <- select(bx, starts_with('beta'))
bx <- as.matrix(bx)

boots <- bx %*% t(pd) # predicted values for every observation for every bootstrap
boots <- as.data.frame(t(boots))
names(boots) <- as.character(c(1:500))
boots <- bind_cols(nd, boots)
boots <- pivot_longer(boots, `1`:`500`)

# first get predicted size at each stage for every bootstrap
boot_means2 <- boots%>%
  group_by(lcl_max_fac)%>%
  summarise(med_rg = (mean(value)), # mean and CI of the bootstraps
            high_rg = (quantile(value, probs = 0.975)),
            low_rg = (quantile(value, probs = 0.025)))
nd <- left_join(nd, boot_means2)
```


```{r}
f1b2 <- ggplot(stage_avg, aes(y = hsi, x = lcl_max_fac)) +
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.15, position = position_jitter(width = 0.3, height = 0),
             aes(size = study_effort)) +
  scale_y_continuous(limits = c(1,4.5), breaks = c(1:6), labels = c("species", tax.ranks)) +
  scale_x_discrete(labels = c("1", "2", "3", "4 or 5")) +
  labs(x = "Life cycle length (max)", y = "Average taxonomic dissimilarity per stage", size = "Pubmed hits") +
  guides(size = FALSE) +
  theme(legend.position = c(0.98, 0.02),
        legend.justification = c(1,0),
        legend.background = element_rect(color = 'black'),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  annotate(geom = 'text', label = "(b)", x = 0.55, y = max(stage_avg$hsi)) +
  geom_line(data = nd, aes(x = lcl, y = preds), 
            alpha = 1, size = 1.5, color = 'black', linetype = 'dashed') +
  geom_linerange(data = nd, 
                  aes(x = lcl, y = preds,
                      ymin = low_rg, ymax = high_rg), 
                  size = 1.5, shape = 23, color = 'black', fill = 'black') +
  geom_point(data = nd,
             aes(x = lcl, y = preds),
             size = 4,
             shape = 23, color = 'black', fill = 'black')
# 
#   geom_line(data = nd, aes(x = lcl, y = preds), 
#             alpha = 1, size = 1.5, color = 'black', linetype = 'dashed') +
#   geom_point(data = nd, aes(x = lcl, y = preds), 
#             size = 5, shape = 23, color = 'black', fill = 'black')

f1b2
```

```{r}
library(cowplot)
```
```{r}
f1 <- plot_grid(f1a2, f1b2, nrow = 1, align = "h")
```
```{r}
fig_width <- 4.5
fig_height <- 4.5

ggsave(filename = "../figs/Fig5_comb.png", plot = f1, device = 'png', units = 'in', width = fig_width*2, height = fig_height) 
ggsave(filename = "../figs/Fig5_comb.svg", plot = f1, device = 'svg', units = 'in', width = fig_width*2, height = fig_height)
```

