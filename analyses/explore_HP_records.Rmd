---
title: "Explore NHM data"
author: "Dan Benesh"
date: "7/2/2019"
output: html_document
---

In this notebook, I explore the data returned by the NHM database. I look at its relationship to life cycle length. I create a dataframe with most of the variables needed for the analysis:

* Two versions of host range, one calculated with just the life cycle database, the other calculated with the life cycle database and NHM database combined
* Two versions of life cycle length, with (max) or without (min) facultative hosts
* Measure of study efforts, the best of which is PubMed hits from query of species name with taxonomic group

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(helminthR)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

```{r importdata}
dat_host <- read.csv(file = "../data/CLC_database_hosts.csv", header = TRUE)
dat_nhm <- read.csv(file = "../data/NHM_db_hosts.csv", header = TRUE)
dat_study <- read.csv(file = "../data/study_effort.csv")
```
```{r}
dat_study <- select(dat_study, Parasite.species, pubs_lcdb = n_lcdb, pubs_pubmed_spname = n_pubmed_spname, pubs_pubmed_spname_group = n_pubmed_spname_group)
```

# Wrangling

First, I make a species level df with host range from just LCDB.

```{r}
num_hosts <- filter(dat_host, !is.na(Host.species), !is.na(Host.common.name))%>%
  select(Parasite.species, Host.species)%>%
  distinct()%>%
  group_by(Parasite.species)%>%
  summarize(num_hosts_lcdb = n())
```

```{r}
#filter(dat_nhm_red, grepl(pattern = "\\(", Host.species))
```

Then I combine the host records from LCDB with those from NHM and again calculate host range.

```{r}
dat_host_red <- filter(dat_host, !is.na(Host.species), !is.na(Host.common.name))%>%
  select(Parasite.species, Host.species)
dat_nhm_red <- select(dat_nhm, Parasite.species = Parasite, Host.species = Host)
dat_lcdb_nhm <- bind_rows(dat_host_red, dat_nhm_red)%>%distinct()
```
```{r}
# calculate number of hosts for each parasite
num_hosts2 <- group_by(dat_lcdb_nhm, Parasite.species)%>%
  summarize(num_hosts_lcdb_nhm = n())
```

Some species names were returned by the NHM queries that were not in the LCDB. Not sure why.

```{r}
# which species names are in NHM, but not LCDB?
select(dat_nhm_red, Parasite.species)%>%
  distinct()%>%
  filter(!(Parasite.species %in% dat_host$Parasite.species))
```

Here are species in the LCDB that did not have hits in the NHM database

```{r}
# which are in lcdb, but not NHM
select(dat_host, Parasite.species)%>%
  distinct()%>%
  filter(!(Parasite.species %in% dat_nhm_red$Parasite.species))
```

We can exclude the extra names returned by the NHM query and limit the database to just records for species names in the LCDB.

```{r}
num_hosts2 <- filter(num_hosts2, Parasite.species %in% dat_host$Parasite.species)
```
```{r}
num_hosts <- left_join(num_hosts, num_hosts2)
```

As we would expect, there is a solid correlation: species with a lot of hosts in the LCDB also tend to have a lot of host records in the life cycle database.

```{r}
ggplot(num_hosts, aes(x = num_hosts_lcdb, y = num_hosts_lcdb_nhm)) + 
  geom_point(alpha = 0.3) + geom_smooth() +
  scale_x_log10() + scale_y_log10()
```

Now, we'll add two measures of life cycle length for each species to the data, the minimum and maximum life cycle length.

```{r}
lcl <- group_by(dat_host, Parasite.species)%>%
  summarize(lcl_max = max(Host.no))

lcl2 <- filter(dat_host, Facultative == 'no')%>%
  select(Parasite.species, Host.no)%>%
  distinct()%>%
  group_by(Parasite.species)%>%
  summarize(lcl_min = n())
```

```{r}
lcl <- left_join(lcl, lcl2)
```

```{r}
dat_comb <- left_join(num_hosts, lcl)
dat_comb <- left_join(dat_comb, dat_study)
rm(lcl, lcl2, num_hosts, num_hosts2)
```

We can examine the correlation matrix for host range, life cycle length, and study effort. These are a little misleading, because some of these variables are skewed with multiplicative errors, i.e. they need to be log transformed.

```{r}
round(cor(select(dat_comb, - Parasite.species)),2)
```

# Modelling

For exploratory purposes, we can fit some simple linear regressions. We need to fit phylogenetic regressions. The simple approach is to fit a base model with study effort, since it is known to affect host range, then we add life cycle length to see if it explains additional variation. We'll start with models for host range from just the LCDB.

Study effort is positively correlated with host range, as expected.

```{r}
m0 <- lm(log10(num_hosts_lcdb) ~ log(pubs_pubmed_spname_group+1), data = dat_comb)
summary(m0)
```

Adding either max or min life cycle length to the regression is a significant improvement, though perhaps moreso for max lcl.

```{r}
m1max <- lm(log10(num_hosts_lcdb) ~ log(pubs_pubmed_spname_group+1) + lcl_max, data = dat_comb)
m1min <- lm(log10(num_hosts_lcdb) ~ log(pubs_pubmed_spname_group+1) + lcl_min, data = dat_comb)
summary(m1max)
summary(m1min)
```

When we look at a model with both measures of life cycle length, we find that only max life cycle is significant. So species with facultative life cycles (i.e. a different min lcl than max lcl) do not clearly have a different host range.

```{r}
m2 <- lm(log10(num_hosts_lcdb) ~ log(pubs_pubmed_spname_group+1) + lcl_max + lcl_min, data = dat_comb)
summary(m2)
```

The residual plot looks pretty reasonable.

```{r}
plot(m2, 1)
```

Here is a plot that summarizes the model results. Given a certain level of study effort, host range is larger for species with longer life cycles.

```{r}
ggplot(dat_comb, aes(x = pubs_pubmed_spname_group+1, y = num_hosts_lcdb, color = factor(lcl_max))) + 
  geom_point(alpha = 0.3) + geom_smooth(method = 'lm') +
  scale_y_log10() + scale_x_log10()
```


Now we will repeat this modelling exercise, but with host range calculated from the combined LCDB and NHM data.

The relationship between host range and study effort is clearer now, which shows how my LCDB was not exhaustive.

```{r}
m0 <- lm(log10(num_hosts_lcdb_nhm) ~ log(pubs_pubmed_spname_group+1), data = dat_comb)
summary(m0)
```

When we add either life cycle length variable separately, they are significant.

```{r}
m1max <- lm(log10(num_hosts_lcdb_nhm) ~ log(pubs_pubmed_spname_group+1) + lcl_max, data = dat_comb)
m1min <- lm(log10(num_hosts_lcdb_nhm) ~ log(pubs_pubmed_spname_group+1) + lcl_min, data = dat_comb)
summary(m1max)
summary(m1min)
```

But again, when both are added simultaneously, the min lcl is not significant.

```{r}
m2 <- lm(log10(num_hosts_lcdb_nhm) ~ log(pubs_pubmed_spname_group+1) + lcl_max + lcl_min, data = dat_comb)
summary(m2)
```

It is worth noting that the parameter estimate is comparable with the two host range measures, 0.27 for the LCDB-only models vs 0.22 for the LCDB-NHM models.

Here is the plot showing the results.

```{r}
ggplot(dat_comb, aes(x = pubs_pubmed_spname_group+1, y = num_hosts_lcdb_nhm, color = factor(lcl_max))) + 
  geom_point(alpha = 0.3) + geom_smooth(method = 'lm') +
  scale_y_log10() + scale_x_log10()
```

Next step is to repeat the analyses accounting for parasite phylogeny. As a minor step in that direction, here is the above plot separated by parasite group. Happily, the pattern appears quite similar in each group.

```{r}
dat_comb <- left_join(dat_comb, select(dat_host, Parasite.species, Parasite.group)%>%distinct())
```

```{r}
ggplot(dat_comb, aes(x = pubs_pubmed_spname_group+1, y = num_hosts_lcdb_nhm, color = factor(lcl_max))) + 
  geom_point(alpha = 0.3) + geom_smooth(method = 'lm') +
  scale_y_log10() + scale_x_log10() +
  facet_wrap(~Parasite.group)
```

