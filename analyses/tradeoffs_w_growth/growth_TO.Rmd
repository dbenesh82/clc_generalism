---
title: "Look for tradeoffs driving host specificity"
output: html_document
---

Why are complex life cycle parasites specific at one stage but not another? Here I explore tradeoffs that might affect the evolution of host specificity in complex life cycles.

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(ape)
library(RColorBrewer)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

```{r importdata}
lcdb <- read.csv(file = "../../data/CLC_database_updated_names.csv", header = TRUE)
st_level <- read.csv(file = "../../data/stage_level_combined.csv", header = TRUE)
tree <- read.tree(file = "../parasite_phylogeny/full_tree_time_calib.nex")
tree_tips <- read.csv(file = "../../data/data_tree_tips_table.csv")
```

[Elsewhere](../stage_level_analyses/make_stage_level_df.Rmd), I created a data table at the level of stages within parasite species. I start by looking at correlations between variables measured at this level, like host records, taxonomic dissimilarity, development time, growth, etc. Here's a correlation matrix, but it might not be too useful, because several variables need log transformation.

```{r}
round(cor(select(st_level, study_effort, num_hosts_suspicious_removed, hsi_lcdb_suspcious_rem, avg_dd, rel_growth_len, rel_growth_biov), use = "pairwise"),2)
```

## Correlations among specificity variables

The host generalism measures are calculated with only the life cycle database, because stage info is not present in the NHM data. The two measures of generalism, number of host species and taxonomic dissimilarity of host species, are positively correlated; stages with more host species (host range) have been recorded from more taxonomically diverse hosts.

```{r}
tax.ranks <- c('genus', 'family', 'order', 'class', 'phylum') # for axis label
```
```{r}
ggplot(st_level, aes(x = num_hosts_suspicious_removed, y = hsi_lcdb_suspcious_rem)) +
  scale_x_log10() +
  scale_y_continuous(limits = c(1,6), breaks = c(1:6), labels = c("species", tax.ranks)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  labs(x = "Host records", y = "Tax dissimilarity index", title = "Stage level")
```

The pattern holds if we exclude stages recorded from just 1 host species. Thus, the two measures are not independent.

```{r}
ggplot(filter(st_level, num_hosts_suspicious_removed > 1),
       aes(x = num_hosts_suspicious_removed, y = hsi_lcdb_suspcious_rem)) +
  scale_x_log10() +
  scale_y_continuous(limits = c(1,6), breaks = c(1:6), labels = c("species", tax.ranks)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  labs(x = "Host records", y = "Tax dissimilarity index", title = "Stage level, n = 1 host removed")
```

Study effort is still an important confounder of generalism measures - the host range increases with study effort, perhaps more for intermediate hosts, than definitive hosts. That sorta makes sense, since fewer studies are on intermediate hosts, it could take more to add new host records.

```{r}
ggplot(st_level, aes(y = num_hosts_suspicious_removed, x = study_effort+1, color = Def.int)) +
  scale_x_log10() + scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  labs(x = "Study effort", y = "Host records", title = "Stage level")
```

Study effort also increases the diversity of hosts at a given stage.

```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = study_effort+1, color = Def.int)) +
  scale_x_log10() + scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  labs(x = "Study effort", y = "Tax dissimilarity index", title = "Stage level")
```


## Correlations among life history variables

I calculated relative and absolute growth for parasite stages, as well as the time needed to complete development at a given stage, in days and degree days.

```{r}
# create starting sizes
st_level <- rename(st_level, stage_length_end = stage_body_length, stage_biov_end = stage_biov)%>%
  mutate(stage_length_start = stage_length_end - abs_growth_len,
         stage_biov_start = stage_biov_end - abs_growth_biov)
```

There is less development time data than growth data. And growth was calculated with two different size variables: length and biovolume. Biovolume had more missing data, because biovolume was calculated with lengths and widths and there were more missing widths than lengths.

```{r}
sapply(select(st_level, avg_dt, avg_dd, abs_growth_len, abs_growth_biov), function(x){sum(is.na(x))})
```

Increases in length are tightly correlated with increases in width, so using length vs biovolume is likely to yield similar results.

```{r}
ggplot(st_level, aes(x = abs_growth_len, y = abs_growth_biov)) +
  scale_x_log10() + 
  scale_y_log10() +
  geom_point(alpha = 0.2)
  #geom_smooth(se = F) 
```

This plot simply shows stage end size as a function of starting size. The lower right is empty because parasites do not shrink. The scatter indicates that growth, in absolute terms, varies quite a lot. For worms entering hosts at a small size (left side), parasites tend to grow more in definitive than intermediate hosts. For large initial sizes (right side), worms grow less, probably because there are limits on how large worms can be.

```{r}
ggplot(st_level, aes(x = stage_biov_start, y = stage_biov_end, color = Def.int)) +
  scale_x_log10() + 
  scale_y_log10() +
  geom_point(alpha = 0.2) +
  #geom_smooth(se = F) 
  labs(x = "Starting size", y = "End size", title = "Stage level")
```

This upper limit on growth is evident when we plot relative growth as a function of starting size. When starting small, parasites may grow many orders of magnitude (or not). But when starting big, they can only increase one or two orders of magnitude.

```{r}
ggplot(st_level, aes(x = stage_biov_start, y = rel_growth_biov, color = Def.int)) +
  scale_x_log10() + 
  #scale_y_log10() +
  geom_point(alpha = 0.2) +
  #geom_smooth(se = F) 
  labs(x = "Starting size", y = "Relative growth (orders of magnitude)", title = "Stage level")
```

The amount of growth a worm does at a given stage depends on how long they spend growing - more time, more growth. We can see that when we plot absolute growth as a function of development time. From this plot, it appears that, for a given length of time, worms grow more in definitive hosts.

```{r}
ggplot(st_level, aes(x = avg_dt, y = abs_growth_biov, color = Def.int)) +
  scale_x_log10() + scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F) +
  labs(x = "Devo time (days)", y = "Absolute growth", title = "Stage level")
```
But that is mainly because they tend to enter the definitive host at a larger size. Large initial sizes facilitate absolute growth, because a doubling in size will result in much more mass when a worm is initially big. When we express growth in relative terms (orders of magnitude increase), then the growth rate appears more comparable in definitive and intermediate hosts.

```{r}
ggplot(st_level, aes(x = avg_dt, y = rel_growth_biov, color = Def.int)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(x = "Devo time (days)", y = "Relative growth (orders of magnitude)", title = "Stage level")

```

There is a lot of variation in the previous plot, and one reason for this is that development is highly temperature dependent. We can try to remove temperature effects by converting development times to degree days. When we make the same plot using degree days, the relationship between growth and time is clearer. Henceforth, I use degree days as my measure of development time.

```{r}
ggplot(st_level, aes(x = avg_dd, y = rel_growth_biov, color = Def.int)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(x = "Devo time (degree days)", y = "Relative growth (orders of magnitude)", title = "Stage level")

```


## Correlations between specificity and life history traits

Next, we look at the relationship between generalism and life history traits. There seems to be a slight negative association between the number of host records and relative growth, but the correlation is not clear.

```{r}
ggplot(st_level, aes(y = num_hosts_suspicious_removed, x = rel_growth_biov, color = Def.int)) +
  # scale_x_log10() + 
  scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Host records", x = "Relative growth", title = "Stage level")
```

A similar pattern is seen for taxonomic dissimilarity.

```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = rel_growth_biov, color = Def.int)) +
  # scale_x_log10() +
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(method = 'lm', se = F) +
  labs(y = "Tax dissimilarity index", x = "Relative growth", title = "Stage level")
```

There are a number of species in the database that infect paratenic hosts. In paratenic hosts, it is usually assumed that the parasite undergoes little to no growth. Consequently, their size in paratenic hosts is often not reported - it is implicitly assumed that little to no growth occurs. Indeed, over 50% of paratenic stages in the database lack sizes compared to only 20% of obligate stages.

```{r}
group_by(st_level, Facultative)%>%
  summarize(total = n(), missing_size =  sum(is.na(stage_biov_end)), missing_growth = sum(is.na(rel_growth_biov)))%>%
  mutate(prop_missing_size = missing_size/total, prop_missing_growth = missing_growth/total)
```
In those cases where size was reported, growth in paratenic hosts is lower than in obligate hosts.

```{r}
ggplot(st_level, aes(x = Facultative, y = rel_growth_biov)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(position = 'jitter', alpha = 0.2)
```

Therefore, for any paratenic host stage without growth data, I set the growth to zero and then replotted the data. This makes the negative relationship clearer, especially for worms in intermediate hosts (since those are the paratenic hosts).

```{r}
st_level <- mutate(st_level, rel_growth_paratenic = if_else(Facultative == "paratenic" & is.na(rel_growth_biov), 0, rel_growth_biov)) # if paratenic, then dt = 0
```
```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = rel_growth_paratenic, color = Def.int)) +
  # scale_x_log10() +
  # scale_y_log10() +
  geom_point(aes(shape = Facultative), alpha = 0.2) +
  geom_smooth(se = F, method = 'lm') +
  labs(y = "Tax dissimilarity index", x = "Relative growth, paratenics added", title = "Stage level")
```

It looks like specificity and growth are linked. Parasites grow less when they are more generalist at a given stage. What about developmental time? Is there a tradeoff between generalism and development?

It does not look like it. Stages with long development times are as generalist as those with short development times.

```{r}
ggplot(st_level, aes(y = num_hosts_suspicious_removed, x = avg_dd, color = Def.int)) +
  scale_x_log10() + scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Host records", x = "Devo time, degree days", title = "Stage level")
```

```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = avg_dd, color = Def.int)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Tax dissim index", x = "Devo time, degree days", title = "Stage level")
```

In paratenic hosts, parasites are assumed to undergo no development. This was implicitly assumed in many papers used to construct the life cycle database. Let's assume that in paratenic hosts, parasites require a day at room temperature to become infective to the next host. When we replot the data, we see that these species in paratenic hosts (left side) tend to have higher generalism.

```{r}
st_level <- mutate(st_level, avg_dd_paratenic = if_else(Facultative == "paratenic" & is.na(avg_dd), 20, avg_dd)) # if paratenic, then dt = 0
```
```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = avg_dd_paratenic, color = Def.int)) +
  scale_x_log10() + 
  #scale_y_log10() +
  geom_point(aes(shape = Facultative), alpha = 0.2) +
  geom_smooth(se = F) +
  labs(y = "Tax dissim index", x = "Devo time, degree days\nparatenic added", title = "Stage level")
```

Here's another way to look at it. Parasites are generalists when infecting paratenic intermediate hosts.

```{r}
ggplot(st_level, aes(x = Facultative, y = hsi_lcdb_suspcious_rem, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  labs(x = "Facultative host?", y = "Taxonomic dissimilarity index")
```


## Break variables by life cycle stage

We can break this down further by looking at how our variables of interest vary across life cycles of different lengths. This plot shows how the middle hosts in long life cycles tend to have higher generalism.

```{r}
ggplot(filter(st_level, Facultative != 'postcyclic'),
       aes(x = factor(Host.no), y = hsi_lcdb_suspcious_rem, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  scale_y_continuous(limits = c(1,6), breaks = c(1:6), labels = c("species", tax.ranks)) +
  labs(x = "Stage (host) in life cycle", y = "Taxonomic dissimilarity") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())
```

Here are the development times in degree days across the life cycle. Development times are often higher in definitive hosts, which is probably because many of these hosts are endotherms (high temperature, many degree days). 

```{r}
ggplot(st_level, aes(x = factor(Host.no), y = avg_dd, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  scale_y_log10() +
  labs(x = "Stage (host) in life cycle", y = "Devo time, degree days") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())
```

Note above that the middle hosts (second, third intermediate hosts) in long life cycles exhibit long development. This pattern can be changed dramatically by assuming that worms essentially undergo no development in paratenic hosts. Under this assumption, we see that second and third intermediate hosts, those most likely to be paratenic hosts, actually have the shortest developmental times.

```{r}
ggplot(st_level, aes(x = factor(Host.no), y = avg_dd_paratenic, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  scale_y_log10() +
  labs(x = "Stage (host) in life cycle", y = "Devo time, degree days") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())
```

Let's next look at how growth, in absolute terms, varies across life cycles. It is usually highest in definitive hosts, again because worms tend to enter definitive hosts large, double in size a few times, and then stop growing.

```{r}
ggplot(st_level, aes(x = factor(Host.no), y = abs_growth_biov, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  scale_y_log10() +
  labs(x = "Stage (host) in life cycle", y = "Absolute growth, length") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())
```

When we look at relative growth, it is rather comparable across stages.

```{r}
ggplot(st_level, aes(x = factor(Host.no), y = rel_growth_biov, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  # scale_y_log10() +
  labs(x = "Stage (host) in life cycle", y = "Rel growth, biovolume") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())

```

However, if we assume that worms do not grow in paratenic hosts, we see that growth is especially low in second and third intermediate hosts.

```{r}
ggplot(st_level, aes(x = factor(Host.no), y = rel_growth_paratenic, color = Def.int)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.1, position = position_jitterdodge(jitter.width = 0.3, jitter.height = 0)) +
  # scale_y_log10() +
  labs(x = "Stage (host) in life cycle", y = "Rel growth, length") +
  facet_wrap(~lcl_max_fac, nrow = 2)+ 
  theme(legend.title = element_blank())

```


# Models

```{r}
st_level <- mutate(st_level, Host_no_fac = if_else(Host.no > 4, as.integer(4), Host.no))%>%
  mutate(Host_no_fac = factor(Host_no_fac))
```

```{r}
library(lme4)
```

I want to test whether life history variables can explain variation in generalism, which would be evidence for a tradeoff. There are several groups of variables to test in the model: (1) uninteresting confounders (phylogeny, study effort), (2) life cycle variables (def vs int, host number), and (3) life history variables (growth and development). I first add the uninteresting confounders to the model, simply to control for them and to be sure that variables added afterwards explain *additional* variation. Here, I'm mainly interested in the life history variables. I could add them to the model either before or after the life cycle variables. If I add them after, I'm testing whether life history explains variation beyond that explained by the life cycle. If I add them before, I'm testing for life history tradeoffs, but their effects are possibly dependent/confounded with life cycle characteristics. I'll take both approaches below.

As for controlling for phylogeny, I added taxonomic categories into a linear mixed model. I did not include the highest and lower taxonomic levels (genus cuts the data quite thin while phylum is too coarse) as this improved model convergence. I still need to look at properly modelling phylogenetic effects

```{r}
# acanth_tax <- read.csv("../parasite_phylogeny/acanth_taxonomy.csv")
# acanth_tax <- select(acanth_tax, species, genus, family, order, class, phylum)
# 
# cest_tax <- read.csv("../parasite_phylogeny/cest_taxonomy.csv")
# cest_tax <- select(cest_tax, species, genus, family, order, class, phylum)
# 
# nem_tax <- read.csv("../parasite_phylogeny/nem_taxonomy_rotl.csv")
# nem_tax <- select(nem_tax, species, genus, family, order, class, phylum)
# 
# worm_tax <- rbind(acanth_tax, cest_tax, nem_tax)
```
```{r}
# st_level <- left_join(st_level, tree_tips) # better worm names here
```
```{r}
# st_level <- mutate(st_level, parasite_genus = substr(tree_tips, start = 1, stop = regexpr("_", tree_tips)-1))
```
```{r}
# join worm taxonomy based on genus name
# st_level <- left_join(st_level, 
#                    select(worm_tax, parasite_genus = genus, parasite_family = family, parasite_order = order, parasite_class = class, parasite_phylum = phylum)
#                    %>%distinct())
```

```{r}
r2_lmm_tax <- function(model) {
  # take in compound poisson mixed model, return marginal and conditional R2, ala Nakagawa et al. 2017
  # marginal r2 is just fixed effects
  # condition r2 is fixed and rand effects combined
  
  # model call
  call <- as.character(model@call)[2]
  
  # parameter estimates and df
  fixed_param <- fixef(model)
  df <- length(fixed_param) - 1
  
  # variance due to fixed effects
  pred <- as.vector(model.matrix(model) %*% fixed_param) # predicteds on basis of just fixed effects
  varF <- var(pred)
  
  
  # variance due to rand effects
  vc <- VarCorr(reg1)
  varR <- vc$Parasite.species[1] + vc$parasite_genus[1] + vc$parasite_family[1] + vc$parasite_order[1] + vc$parasite_class[1] + vc$parasite_phylum[1]
  
  # residual var
  varE <- attr(vc, 'sc')^2
  
  
  
  # marginal r2
  mr2 <- varF/(varF + varR + varE)
  
  # conditional r2
  cr2 <- (varF + varR)/(varF + varR + varE)
  
  # output
  out_frame <- data_frame(call = call, df = df, marg_r2 = round(mr2, 3), cond_r2 = round(cr2,3))
  return(out_frame)
}
```


# Host range

### Case 1

I look first at host range. The *Case 1* approach is the simpler one. Ignoring life cycle variables, does life history matter for stage generalism? I fit 3 linear mixed models: (1) start with taxonomic random effects, (2) add study effort, and (3) add the life history variable, in this first case relative growth.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_biov) # add rel growth
```

#### Relative growth
Adding relative growth to a model with just parasite taxonomy and study effort is a slight improvement.

```{r}
anova(reg0, reg1, reg2)
```

Here's the regression parameters.

```{r}
summary(reg2)
```

The R^2^ improvement through adding parasite growth is small.

```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

The same pattern is seen if we assume worms do not grow in paratenic hosts. Surprisingly, though, the effect, judged by the Chisq stat, is not much stronger.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_paratenic) # add rel growth
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```
Here's the regression parameters.

```{r}
summary(reg2)
```

The negative correlation is mainly driven by paratenic hosts. If we exclude them, the relationship between generalism and growth is still negative, but it is weaker and not significant.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov), Facultative == 'no')) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_paratenic) # add rel growth
anova(reg0, reg1, reg2)
```

#### Development time

Moving on to development time. Short development times were associated with higher generalism, which is consistent with a tradeoff, but the pattern was not significant.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + log10(avg_dd)) # add devo
anova(reg0, reg1, reg2)
```

Here's the model output.
```{r}
summary(reg2)
```


```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

However, if we assume development in paratenic hosts is short (1 day), then there is a significant negative relationship.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + log10(avg_dd_paratenic)) # add devo
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```
The variation in host generalism explained by stage growth and development is not independent. That is indicated by the fact that adding development to a model with relative growth is not an improvement. Although it is important to keep in mind that the sample size is smaller when considering development and growth simultaneously (some stages with growth data lack development data and vice versa).

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov), !is.na(avg_dd))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_biov) # add rel growth
reg3 <- update(reg2, . ~ . + log10(avg_dd)) # add rel growth
anova(reg0, reg1, reg2, reg3)
```


### Case 2

We know that growth, development, and specificity vary across life cycles. Do life cycle variables like host number or host type (definitive vs intermediate) explain the variation in host generalism better? In other words, does life history explain variation in generalism beyond that explained by the life cycle itself? Now, I examine life history variables *after* building a model that includes life cycle characteristics.

#### Relative growth

Here are a series of models indicating that (1) study effort affects host counts, (2) the distinction between intermediate and definitive host is not important, (3) host number matters (generalism is highest in second and third hosts), and (4) finally adding relative growth is a slight improvement.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + rel_growth_biov) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

Check whether this changes after imputing data for paratenic stages. The effect of parasite growth is actually non-significant! Stage info must explain that imputed variation.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + rel_growth_paratenic) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```


#### Development time

On the other hand, adding development time to a model with life cycle characteristics is not an improvement.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + log10(avg_dd)) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

When we assume development does not occur in paratenic hosts, the results change slightly. Specifically, life cycle characteristics become more important, i.e. being a second or third intermediate hosts, but developmental time still does not explain additional variation beyond that explained by the life cycle.

```{r}
reg0 <- lmer(log10(num_hosts_suspicious_removed) ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + log10(avg_dd_paratenic)) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```


# Taxonomic dissimilarity


Moving onto the next generalism variable: taxonomic dissimilarity.

### Case 1
#### Relative growth

As above, adding relative growth to a model with just taxonomy and study effort is an improvement. It has about the same magnitude effect as study effort. 

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_biov) # add rel growth
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

The same pattern is seen if we assume worms do not grow in paratenic hosts, in fact the effect size is quite a bit larger.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + rel_growth_paratenic) # add rel growth
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

#### Development time
The taxonomic diversity of hosts is negatively related to developmental times (quick development - high generalism; long development - low generalism). 

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + log10(avg_dd)) # add devo
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```
This is strongly exacerbated by assuming minimal development in paratenic hosts. Short development and generalism are associated.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + log10(avg_dd_paratenic)) # add devo
anova(reg0, reg1, reg2)
```
```{r}
mod_list <- list(reg0, reg1, reg2)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```


### Case 2
#### Relative growth

Is the variation in taxonomic dissimilarity caused by life history variables simply due to life cycle characteristics? 

In the series of models below, the distinction between intermediate vs definitive hosts is mildly significant and the host number matters (highest in second and third hosts). Adding relative growth is a clear improvement.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_biov))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + rel_growth_biov) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

The same results are seen under the assumption of limited growth in paratenic hosts.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(rel_growth_paratenic))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + rel_growth_paratenic) # add stage level growth

anova(reg0, reg1, reg2, reg3, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "growth")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

#### Development time

Parasite stages with a taxonomically diverse set of hosts have slightly shorter development times, even after accounting for life cycle characteristics.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd))) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + log10(avg_dd)) # add stage level growth

anova(reg0, reg1, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

When we assume development does not occur in paratenic hosts, the results change in the same way they changed for host range above. Specifically, life cycle characteristics become more important, but developmental time still does not explain additional variation beyond that explained by the life cycle.

```{r}
reg0 <- lmer(hsi_lcdb_suspcious_rem ~ 1 + (1|Parasite.species) + (1|parasite_genus) + (1|parasite_family) + (1|parasite_order) + (1|parasite_class) + (1|parasite_phylum),
             data = filter(st_level, !is.na(avg_dd_paratenic), stage_missing_info != "stage with missing info in cycle")) # just w/in species effect
reg1 <- update(reg0, . ~ . + log10(study_effort+1)) # add study effort (species level predictor)
reg2 <- update(reg1, . ~ . + Def.int) # distinguish adults and larvae
reg3 <- update(reg2, . ~ . + Host_no_fac) # distinguish worms in 1st, 2nd host, etc.
reg4 <- update(reg3, . ~ . + Host_no_fac*Def.int) # distinguish adults in 1st, 2nd host from larvae in 1st, 2nd host, etc.
reg5 <- update(reg4, . ~ . + log10(avg_dd_paratenic)) # add stage level growth

anova(reg0, reg1, reg2, reg3, reg4, reg5)
```
```{r}
mod_list <- list(reg0, reg1, reg2, reg3, reg4, reg5)
if(exists("r2_table")){rm(r2_table)}
i <- 1
for(model in mod_list){
  if(i == 1){
    r2_table <- r2_lmm_tax(model)
  } else {
    r2_table <- rbind(r2_table, r2_lmm_tax(model))
  }
  i <- i + 1
}


r2_table <- mutate(r2_table, tax_var_explained = cond_r2 - marg_r2, df_used = df - lag(df))
r2_table$step <- c("taxonomy", "study effort", "stage function", "host number", "host x stage", "development")
r2_table <- select(r2_table, step, df_used, marg_r2, cond_r2, tax_var_explained)
r2_table
```

## Summary figures

How to graph these differences? One option is to split the data by the life cycle variables or by the host number.

```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = avg_dd_paratenic, color = Def.int)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Tax dissim index", x = "Devo time, degree days", title = "Host number") +
  facet_wrap(~Host_no_fac, nrow = 3)
```
```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = rel_growth_biov, color = Def.int)) +
  # scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Tax dissim index", x = "Relative growth", title = "Host number") +
  facet_wrap(~Host_no_fac, nrow = 3)
```

Another option is to look at dissimilarity overall, with no regard to the life cycle variables.

```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = rel_growth_paratenic)) +
  # scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Tax dissim index", x = "Relative growth") 
```
```{r}
ggplot(st_level, aes(y = hsi_lcdb_suspcious_rem, x = avg_dd_paratenic)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(alpha = 0.2) +
  geom_smooth(se = F, method = lm) +
  labs(y = "Tax dissim index", x = "Degree days")
```

One final option is to try and plot generalism as a function of both growth and development.

```{r}
st_level <- mutate(st_level, generalist_fac = cut(hsi_lcdb_suspcious_rem, breaks = c(0,1,2.5,6)))%>% # cut tax dissim into three roughly equal groups
  mutate(generalist_fac = factor(generalist_fac, labels = c("specialist", "average", "generalist")))
```
```{r}

st_level_dt <- group_by(st_level, generalist_fac)%>%
  summarize(avg_dd_p = mean(avg_dd_paratenic, na.rm = T),
            sd_dd_p = sd(avg_dd_paratenic, na.rm = T),
            n_dt = sum(!is.na(avg_dd_paratenic)),
            
            avg_g_p = mean(rel_growth_paratenic, na.rm = T),
            sd_g_p = sd(rel_growth_paratenic, na.rm = T),
            n_g = sum(!is.na(rel_growth_paratenic))
            )
st_level_dt <- mutate(st_level_dt, se_dd_p = sd_dd_p/sqrt(n_dt), se_g_p = sd_g_p/sqrt(n_g))%>%na.omit()

```

This plot shows the relationship between growth and development (longer development, more growth). The taxonomic dissimilarity values were categorized into thirds (i.e. specialist, average, generalist). The overall means are also plotted. They 'generalism spectrum' separates more along the y-axis (growth) than the x (development). This may not be the best way to generalize the data, but generalist stages are those in which worms grow less and shorter.

```{r}
ggplot(st_level, aes(x = avg_dd_paratenic, y = rel_growth_paratenic)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(aes(shape = Facultative, color = generalist_fac), alpha = 0.3) +
  geom_point(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, color = generalist_fac), size = 5) +
  geom_errorbar(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, ymin = avg_g_p - se_g_p, ymax = avg_g_p + se_g_p)) +
  geom_errorbarh(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, xmin = avg_dd_p - se_dd_p, xmax = avg_dd_p + se_dd_p))+
  # geom_smooth(se = F, method = lm) 
  labs(y = "Relative growth in stage", x = "Devo time, degree days", title = "Generalism split into thirds") 
```

The differences might be a little clearer when we break the data by taxonomic rank.

```{r}
st_level <- mutate(st_level, generalist_fac = cut(hsi_lcdb_suspcious_rem, breaks = c(0,1, 2, 3, 4, 6)))%>% # cut tax dissim into three roughly equal groups
  mutate(generalist_fac = factor(generalist_fac, labels = c("species", "genus", "family", "order", "class+")))
```
```{r}
st_level_dt <- group_by(st_level, generalist_fac)%>%
  summarize(avg_dd_p = mean(avg_dd_paratenic, na.rm = T),
            sd_dd_p = sd(avg_dd_paratenic, na.rm = T),
            n_dt = sum(!is.na(avg_dd_paratenic)),
            
            avg_g_p = mean(rel_growth_paratenic, na.rm = T),
            sd_g_p = sd(rel_growth_paratenic, na.rm = T),
            n_g = sum(!is.na(rel_growth_paratenic))
            )
st_level_dt <- mutate(st_level_dt, se_dd_p = sd_dd_p/sqrt(n_dt), se_g_p = sd_g_p/sqrt(n_g))%>%na.omit()

```

If parasite stages infect hosts from different classes, then they exhibit short development and little growth. By contrast, if hosts for a given parasite stage tend to be of the same genus or family, then the parasite stage tend to spend time growing.

```{r}
ggplot(st_level, aes(x = avg_dd_paratenic, y = rel_growth_paratenic)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(aes(shape = Facultative, color = generalist_fac), alpha = 0.3) +
  geom_point(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, color = generalist_fac), size = 5) +
  geom_errorbar(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, ymin = avg_g_p - se_g_p, ymax = avg_g_p + se_g_p)) +
  geom_errorbarh(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, xmin = avg_dd_p - se_dd_p, xmax = avg_dd_p + se_dd_p))+
  labs(y = "Relative growth in stage", x = "Devo time, degree days", title = "Generalism defined by tax dissim") 
```

Here's the same figure, excluding paratenics. The separation along the x-axis is no longer obvious, but the relationship with growth is still visible.

```{r}
st_level_dt <- group_by(st_level, generalist_fac)%>%
  summarize(avg_dd_p = mean(avg_dd, na.rm = T),
            sd_dd_p = sd(avg_dd, na.rm = T),
            n_dt = sum(!is.na(avg_dd)),
            
            avg_g_p = mean(rel_growth_biov, na.rm = T),
            sd_g_p = sd(rel_growth_biov, na.rm = T),
            n_g = sum(!is.na(rel_growth_biov))
            )
st_level_dt <- mutate(st_level_dt, se_dd_p = sd_dd_p/sqrt(n_dt), se_g_p = sd_g_p/sqrt(n_g))%>%na.omit()
```
```{r}
ggplot(st_level, aes(x = avg_dd, y = rel_growth_biov)) +
  scale_x_log10() + 
  # scale_y_log10() +
  geom_point(aes(shape = Facultative, color = generalist_fac), alpha = 0.3) +
  geom_point(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, color = generalist_fac), size = 5) +
  geom_errorbar(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, ymin = avg_g_p - se_g_p, ymax = avg_g_p + se_g_p)) +
  geom_errorbarh(data = st_level_dt, aes(x = avg_dd_p, y = avg_g_p, xmin = avg_dd_p - se_dd_p, xmax = avg_dd_p + se_dd_p))+
  labs(y = "Relative growth in stage", x = "Devo time, degree days", title = "Generalism defined by tax dissim, exclude paratenics") 
```


# Within-species correlations

```{r}
detach(package:lme4, unload = T)
```

Up to this point, I have looked for general correlations across species while controlling for 'species effects'. However, it may be that species that are generalist at one stage of the life cycle are less so at another stage. Let's look at the correlations within species.

#### Generalism

```{r}
# select relevant columns (already species avgs) and spread the data
st_spread_hsi <- filter(st_level, stage_missing_info == 'complete')%>%
  select(Parasite.species, Host.no, hsi_lcdb_suspcious_rem, study_effort, lcl_max, lcl_min, lcl_max_fac)%>%
  spread(key = Host.no, value = hsi_lcdb_suspcious_rem)%>%
  rename(first_host = `1`, second_host = `2`, third_host = `3`, fourth_host = `4`, fifth_host = `5`)
```

In complex life cycle worms, generalism in the first and second host is uncorrelated (if anything it is positively correlated), which is not consistent with a tradeoff.

```{r}
ggplot(filter(st_spread_hsi, lcl_max > 1),
       aes(x = first_host, y = second_host)) +
  geom_point(aes(size = study_effort), alpha = 0.3) + 
  geom_smooth(se = F) +
  labs(x = "Tax dissimilarity in first host", y = "Tax dissimilarity in second host", title = "Generalism between hosts, panels are life cycle length") +
  facet_wrap(~lcl_max_fac, nrow=2)
```

```{r}
# x <- glm(first_host ~ second_host + log(study_effort+1), data = filter(st_spread_hsi, lcl_max == 2))
# summary(x)
```

#### Growth
We can also look at growth in consecutive hosts.

```{r}
# select relevant columns (already species avgs) and spread the data
st_spread_hsi <- filter(st_level, stage_missing_info == 'complete')%>%
  select(Parasite.species, Host.no, abs_growth_biov, study_effort, lcl_max, lcl_min, lcl_max_fac)%>%
  spread(key = Host.no, value = abs_growth_biov)%>%
  rename(first_host = `1`, second_host = `2`, third_host = `3`, fourth_host = `4`, fifth_host = `5`)
```

In absolute terms, worms that grow larger in their first host tend to also grow large in the second host. Presumably, size is just compounding itself across hosts - large worms can more easily accumulate additional mass in absolute terms.

```{r}
ggplot(filter(st_spread_hsi, lcl_max > 1),
       aes(x = first_host, y = second_host)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(se = F, method = 'lm') +
  scale_y_log10() + scale_x_log10() +
  labs(x = "Absolute growth in first host", y = "Absolute growth in second host", title = "Growth between hosts, panels are life cycle length") +
  facet_wrap(~lcl_max_fac, nrow=2)
```

However, it relative terms, more growth in the first host leaves less opportunity for large increases in growth in the next host - there is a negative relationship between relative growth across hosts.

```{r}
# select relevant columns (already species avgs) and spread the data
st_spread_hsi <- filter(st_level, stage_missing_info == 'complete')%>%
  select(Parasite.species, Host.no, rel_growth_paratenic, study_effort, lcl_max, lcl_min, lcl_max_fac)%>%
  spread(key = Host.no, value = rel_growth_paratenic)%>%
  rename(first_host = `1`, second_host = `2`, third_host = `3`, fourth_host = `4`, fifth_host = `5`)
```
```{r}
ggplot(filter(st_spread_hsi, lcl_max > 1),
       aes(x = first_host, y = second_host)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(se = F) +
  labs(x = "Relative growth in first host", y = "Relative growth in second host", title = "Growth between hosts, panels are life cycle length") +
  facet_wrap(~lcl_max_fac, nrow=2)
```

#### Devo times

There are not many examples of development times being recorded across multiple stages of a parasite life cycle. Still, no pattern is apparent.

```{r}
# select relevant columns (already species avgs) and spread the data
st_spread_hsi <- filter(st_level, stage_missing_info == 'complete')%>%
  select(Parasite.species, Host.no, avg_dd_paratenic, study_effort, lcl_max, lcl_min, lcl_max_fac)%>%
  spread(key = Host.no, value = avg_dd_paratenic)%>%
  rename(first_host = `1`, second_host = `2`, third_host = `3`, fourth_host = `4`, fifth_host = `5`)
```

```{r}
ggplot(filter(st_spread_hsi, lcl_max > 1),
       aes(x = first_host, y = second_host)) +
  geom_point(alpha = 0.3) + 
  geom_smooth(se = F, method = "lm") +
  scale_y_log10() + scale_x_log10() +
  labs(x = "Development time in first host", y = "Development time in second host", title = "Devo time, panels are life cycle length") +
  facet_wrap(~lcl_max_fac, nrow=2)
```


# Conclusions

Parasite life cycle, life history, and patterns of host generalism are related. In particular, parasite exhibit high generalism in second or third intermediate hosts. These tend to be paratenic hosts, in which parasites undergo little growth and development. But even if these hosts are excluded, there is still a negative relationship between generalism and worm growth. Worms grow less in stages where they infect a broader range of hosts, which is consistent with costs of generalism.